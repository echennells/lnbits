{% extends "base.html" %}
{% from "macros.jinja" import window_vars with context %}

{% block scripts %}
{{ window_vars(user) }}
<script src="{{ static_url_for('taproot_assets/static', path='js/index.js') }}"></script>
{% endblock %}

{% block page %}
<div class="row q-col-gutter-md">
  <div class="col-12 col-md-8 col-lg-7 q-gutter-y-md">
    <q-card>
      <q-card-section>
        <div class="row items-center no-wrap q-mb-sm">
          <div class="col">
            <h5 class="text-subtitle1 q-my-none">Taproot Assets</h5>
          </div>
          <div class="col-auto">
            <q-btn flat color="grey" @click="$router.go(-1)">
              <q-icon left name="arrow_back"></q-icon>
              Back
            </q-btn>
          </div>
        </div>
        <q-separator></q-separator>
      </q-card-section>

      <q-card-section>
        <div v-if="assets && assets.length === 0" class="text-center text-grey-6">
          No assets found. Connect to a Taproot Assets daemon in the settings.
        </div>
        <div v-if="assets && assets.length > 0">
          <h6 class="text-subtitle1 q-my-none">Your Assets</h6>
          <q-separator class="q-my-sm"></q-separator>
          <div v-for="asset in assets" :key="asset.id" class="q-card-section">
            <div class="row items-center no-wrap">
              <div class="col">
                <span>{% raw %}{{ asset.name ? asset.name : 'Unknown (' + asset.type + ')' }}{% endraw %}</span>
              </div>
              <div class="col-auto">
                <q-btn flat color="primary" @click="createInvoice(asset.id)">
                  <q-icon left name="arrow_upward"></q-icon>
                  RECEIVE
                </q-btn>
              </div>
            </div>
            <div class="text-grey-6 q-mt-sm">
              Asset ID: {% raw %}{{ asset.id }}{% endraw %}<br>
              Amount: {% raw %}{{ asset.amount }}{% endraw %}<br>
              Type: {% raw %}{{ asset.type }}{% endraw %}
            </div>
          </div>
        </div>
      </q-card-section>

      <q-card-section>
        <h6 class="text-subtitle1 q-my-none">Recent Invoices</h6>
        <q-separator class="q-my-sm"></q-separator>
        <div v-if="invoices && invoices.length === 0" class="text-center text-grey-6">
          No invoices found.
        </div>
        <div v-if="invoices && invoices.length > 0">
          <q-list bordered class="rounded-borders">
            <q-item v-for="invoice in invoices" :key="invoice.id" clickable v-ripple>
              <q-item-section>
                <q-item-label>{% raw %}{{ invoice.memo || 'No memo' }}{% endraw %}</q-item-label>
                <q-item-label caption>
                  Amount: {% raw %}{{ invoice.amount }} {{ invoice.unit }}{% endraw %}<br>
                  Status: <span :class="'text-' + getStatusColor(invoice.status)">{% raw %}{{ invoice.status }}{% endraw %}</span><br>
                  Created: {% raw %}{{ formatDate(invoice.created) }}{% endraw %}
                </q-item-label>
              </q-item-section>
              <q-item-section side>
                <q-btn flat round dense icon="content_copy" @click="copyInvoice(invoice.payment_request || invoice.id)" />
              </q-item-section>
            </q-item>
          </q-list>
        </div>
      </q-card-section>
    </q-card>
  </div>

  <div class="col-12 col-md-4 col-lg-5">
    <q-card>
      <q-card-section>
        <h6 class="text-subtitle1 q-my-none">Create Invoice</h6>
        <q-separator class="q-my-sm"></q-separator>
        <q-form @submit="submitInvoice" class="q-gutter-md">
          <q-select v-model="invoiceForm.asset_id" label="Asset" :options="{% raw %}assets.map(a => ({ label: a.name || 'Unknown (' + a.type + ')', value: a.id })){% endraw %}" outlined @input="setAssetName($event)" required>
            <template v-slot:append>
              <q-tooltip>Select the asset by name</q-tooltip>
            </template>
          </q-select>
          <q-input v-model.number="invoiceForm.amount" type="number" label="Amount" outlined required />
          <q-input v-model="invoiceForm.memo" label="Memo (optional)" outlined />
          <q-input v-model.number="invoiceForm.expiry" type="number" label="Expiry (seconds)" outlined value="3600" />
          <div class="row q-mt-lg">
            <q-btn type="submit" color="primary" label="CREATE INVOICE" />
            <q-btn flat color="grey" label="CANCEL" class="q-ml-sm" @click="showInvoiceForm = false" />
          </div>
        </q-form>
      </q-card-section>
    </q-card>

    <q-card v-if="createdInvoice" class="q-mt-md">
      <q-card-section>
        <h6 class="text-subtitle1 q-my-none">Invoice Created</h6>
        <q-separator class="q-my-sm"></q-separator>
        <div>
          <q-btn flat round dense icon="content_copy" @click="copyInvoice(createdInvoice.payment_request || createdInvoice.id)" />
          <span class="q-ml-sm">Amount: {% raw %}{{ createdInvoice.amount }} ({{ createdInvoice.unit }}){% endraw %}</span><br>
          <span>Satoshi Amount: {% raw %}{{ createdInvoice.satoshi_amount }}{% endraw %} sats</span>
        </div>
        <div class="text-grey-6 q-mt-sm">
          Asset ID: {% raw %}{{ createdInvoice.asset_id }}{% endraw %}<br>
          Status: <span :class="'text-' + getStatusColor(createdInvoice.status)">{% raw %}{{ createdInvoice.status }}{% endraw %}</span><br>
          Created: {% raw %}{{ formatDate(createdInvoice.created) }}{% endraw %}
        </div>
      </q-card-section>
    </q-card>
  </div>
</div>
{% endblock %}
